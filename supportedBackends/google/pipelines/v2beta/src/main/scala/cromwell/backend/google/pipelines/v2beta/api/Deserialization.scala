package cromwell.backend.google.pipelines.v2beta.api

import java.io.ByteArrayInputStream
import java.nio.charset.StandardCharsets
import java.util.{ArrayList => JArrayList, Map => JMap}

import cats.instances.list._
import cats.syntax.traverse._
import cats.syntax.validated._
import com.google.api.client.json.jackson2.JacksonFactory
import com.google.api.client.json.{GenericJson, JsonObjectParser}
import com.google.api.services.lifesciences.v2beta.model._
import com.typesafe.scalalogging.Logger
import common.validation.ErrorOr._
import common.validation.Validation._
import mouse.all._
import org.slf4j.LoggerFactory

import scala.collection.JavaConverters._
import scala.reflect.ClassTag
import scala.util.Try

/**
  * This bundles up some code to work around the fact that Operation is not deserialized
  * completely from the JSON HTTP response.
  * For instance, the metadata field is a Map[String, Object] even though it represents "Metadata"
  * for which there's an existing class.
  * This class provides implicit functions to deserialize those map to their proper type.
  */
private [api] object Deserialization {

  private val logger: Logger = Logger(LoggerFactory.getLogger(getClass.getName))

  private val jsonFactory = new JacksonFactory
  private val jsonParser = new JsonObjectParser.Builder(jsonFactory).build

  implicit class OperationDeserialization(val operation: Operation) extends AnyVal {
    /**
      * Deserializes the events to com.google.api.services.genomics.v2beta.model.Event
      */
    def events: ErrorOr[List[Event]] = {
      val eventsErrorOrOption = for {
        eventsMap <- metadata.get("events")
        eventsErrorOr <- Option(eventsMap
          .asInstanceOf[JArrayList[JMap[String, Object]]]
          .asScala
          .toList
          .traverse[ErrorOr, Event](deserializeToEvent(_).toErrorOr)
        )
      } yield eventsErrorOr
      eventsErrorOrOption.getOrElse(Nil.validNel)
    }

    /**
      * Deserializes the pipeline to com.google.api.services.genomics.v2beta.model.Pipeline
      */
    def pipeline: Option[Try[Pipeline]] = {
      metadata
        .get("pipeline")
        .map(_.asInstanceOf[JMap[String, Object]] |> deserializeTo[Pipeline])
    }

    // If there's a WorkerAssignedEvent it means a VM was created - which we consider as the job started
    // Note that the VM might still be booting
    def hasStarted = events.toOption.exists(_.exists(_.getWorkerAssigned != null))

    def metadata: Map[String, AnyRef] = {
      val metadataOption = for {
        operationValue <- Option(operation)
        metadataJava <- Option(operationValue.getMetadata)
      } yield metadataJava.asScala.toMap
      metadataOption.getOrElse(Map.empty)
    }
  }

  /**
    * Deserializes a java.util.Map[String, Object] to an instance of T
    */
  private [api] def deserializeTo[T <: GenericJson](attributes: JMap[String, Object])(implicit tag: ClassTag[T]): Try[T] = Try {
    val jsonString = jsonFactory.toString(attributes)
    logger.info(Thread.currentThread.getName + " " + jsonString)
    jsonParser.parseAndClose[T](new ByteArrayInputStream(jsonString.getBytes), StandardCharsets.UTF_8, tag.runtimeClass.asInstanceOf[Class[T]])
  }

  private [api] def deserializeToEvent(attributes: JMap[String, Object]): Try[Event] = Try {
    val jsonString = "{\"actions\":[{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"python -c 'import base64; print(base64.b64decode(\\\"IyEvYmluL2Jhc2gKCndoaWxlIHRydWU7IGRvCiAgKAogICAgZm9yIGkgaW4gJChzZXEgMyk7IGRvCiAgKAogICAgcm0gLWYgJEhPTUUvLmNvbmZpZy9nY2xvdWQvZ2NlICYmIGdzdXRpbCAgLWggIkNvbnRlbnQtVHlwZTogdGV4dC9wbGFpbjsgY2hhcnNldD1VVEYtOCIgY3AgL2dvb2dsZS9sb2dzL291dHB1dCBnczovL2Nsb3VkLWNyb213ZWxsLWRldi1zZWxmLWNsZWFuaW5nL2Nyb213ZWxsX2V4ZWN1dGlvbi9jaS93L2FkNTUxZWZkLWJiZjUtNDEwOC05MjAxLWY0MDIyMWVlYTc5Zi9jYWxsLUUvc2hhcmQtNC9FLTQubG9nID4gZ3N1dGlsX291dHB1dC50eHQgMj4mMQojIFJlY29yZCB0aGUgZXhpdCBjb2RlIG9mIHRoZSBnc3V0aWwgY29tbWFuZCB3aXRob3V0IHByb2plY3QgZmxhZwpSQ19HU1VUSUw9JD8KaWYgWyAiJFJDX0dTVVRJTCIgIT0gIjAiIF07IHRoZW4KICBwcmludGYgJyVzICVzXG4nICIkKGRhdGUgLXUgJyslWS8lbS8lZCAlSDolTTolUycpIiBybVwgLWZcIFwkSE9NRS8uY29uZmlnL2djbG91ZC9nY2VcIFwmXCZcIGdzdXRpbFwgXCAtaFwgXCJDb250ZW50LVR5cGU6XCB0ZXh0L3BsYWluXDtcIGNoYXJzZXRcPVVURi04XCJcIGNwXCAvZ29vZ2xlL2xvZ3Mvb3V0cHV0XCBnczovL2Nsb3VkLWNyb213ZWxsLWRldi1zZWxmLWNsZWFuaW5nL2Nyb213ZWxsX2V4ZWN1dGlvbi9jaS93L2FkNTUxZWZkLWJiZjUtNDEwOC05MjAxLWY0MDIyMWVlYTc5Zi9jYWxsLUUvc2hhcmQtNC9FLTQubG9nXCBmYWlsZWQKICAjIFByaW50IHRoZSByZWFzb24gb2YgdGhlIGZhaWx1cmUKICBjYXQgZ3N1dGlsX291dHB1dC50eHQKCiAgIyBDaGVjayBpZiBpdCBtYXRjaGVzIHRoZSBCdWNrZXRJc1JlcXVlc3RlclBheXNFcnJvck1lc3NhZ2UKICBpZiBncmVwIC1xICJCdWNrZXQgaXMgcmVxdWVzdGVyIHBheXMgYnVja2V0IGJ1dCBubyB1c2VyIHByb2plY3QgcHJvdmlkZWQuIiBnc3V0aWxfb3V0cHV0LnR4dDsgdGhlbgogICAgcHJpbnRmICclcyAlc1xuJyAiJChkYXRlIC11ICcrJVkvJW0vJWQgJUg6JU06JVMnKSIgUmV0cnlpbmdcIHdpdGhcIHVzZXJcIHByb2plY3QKICAgIHJtIC1mICRIT01FLy5jb25maWcvZ2Nsb3VkL2djZSAmJiBnc3V0aWwgLXUgYnJvYWQtZHNkZS1jcm9td2VsbC1kZXYgLWggIkNvbnRlbnQtVHlwZTogdGV4dC9wbGFpbjsgY2hhcnNldD1VVEYtOCIgY3AgL2dvb2dsZS9sb2dzL291dHB1dCBnczovL2Nsb3VkLWNyb213ZWxsLWRldi1zZWxmLWNsZWFuaW5nL2Nyb213ZWxsX2V4ZWN1dGlvbi9jaS93L2FkNTUxZWZkLWJiZjUtNDEwOC05MjAxLWY0MDIyMWVlYTc5Zi9jYWxsLUUvc2hhcmQtNC9FLTQubG9nCiAgZWxzZQogICAgZXhpdCAiJFJDX0dTVVRJTCIKICBmaQplbHNlCiAgZXhpdCAwCmZpCiAgKQogIFJDPSQ/CiAgaWYgWyAiJFJDIiA9ICIwIiBdOyB0aGVuCiAgICBicmVhawogIGZpCiAgaWYgWyAkaSAtbHQgMyBdOyB0aGVuCiAgICBwcmludGYgJyVzICVzXG4nICIkKGRhdGUgLXUgJyslWS8lbS8lZCAlSDolTTolUycpIiBXYWl0aW5nXCA1XCBzZWNvbmRzXCBhbmRcIHJldHJ5aW5nCiAgICBzbGVlcCA1CiAgZmkKZG9uZQpleGl0ICIkUkMiCiAgKSA+IC9kZXYvbnVsbCAyPiYxCiAgc2xlZXAgMzAKZG9uZQ==\\\"));' > /tmp/c9048b78-461d-4f4e-85d6-26f3d349a06e.sh && chmod u+x /tmp/c9048b78-461d-4f4e-85d6-26f3d349a06e.sh && sh /tmp/c9048b78-461d-4f4e-85d6-26f3d349a06e.sh\"],\"labels\":{\"tag\":\"Background\"},\"runInBackground\":true},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"python -c 'import base64; print(base64.b64decode(\\\"IyEvYmluL2Jhc2gKCndoaWxlIHRydWU7IGRvCiAgKAogICAgZm9yIGkgaW4gJChzZXEgMyk7IGRvCiAgKAogICAgcm0gLWYgJEhPTUUvLmNvbmZpZy9nY2xvdWQvZ2NlICYmIGdzdXRpbCAgLWggIkNvbnRlbnQtVHlwZTogdGV4dC9wbGFpbjsgY2hhcnNldD1VVEYtOCIgY3AgL2Nyb213ZWxsX3Jvb3Qvc3RkZXJyIGdzOi8vY2xvdWQtY3JvbXdlbGwtZGV2LXNlbGYtY2xlYW5pbmcvY3JvbXdlbGxfZXhlY3V0aW9uL2NpL3cvYWQ1NTFlZmQtYmJmNS00MTA4LTkyMDEtZjQwMjIxZWVhNzlmL2NhbGwtRS9zaGFyZC00LyA+IGdzdXRpbF9vdXRwdXQudHh0IDI+JjEKIyBSZWNvcmQgdGhlIGV4aXQgY29kZSBvZiB0aGUgZ3N1dGlsIGNvbW1hbmQgd2l0aG91dCBwcm9qZWN0IGZsYWcKUkNfR1NVVElMPSQ/CmlmIFsgIiRSQ19HU1VUSUwiICE9ICIwIiBdOyB0aGVuCiAgcHJpbnRmICclcyAlc1xuJyAiJChkYXRlIC11ICcrJVkvJW0vJWQgJUg6JU06JVMnKSIgcm1cIC1mXCBcJEhPTUUvLmNvbmZpZy9nY2xvdWQvZ2NlXCBcJlwmXCBnc3V0aWxcIFwgLWhcIFwiQ29udGVudC1UeXBlOlwgdGV4dC9wbGFpblw7XCBjaGFyc2V0XD1VVEYtOFwiXCBjcFwgL2Nyb213ZWxsX3Jvb3Qvc3RkZXJyXCBnczovL2Nsb3VkLWNyb213ZWxsLWRldi1zZWxmLWNsZWFuaW5nL2Nyb213ZWxsX2V4ZWN1dGlvbi9jaS93L2FkNTUxZWZkLWJiZjUtNDEwOC05MjAxLWY0MDIyMWVlYTc5Zi9jYWxsLUUvc2hhcmQtNC9cIGZhaWxlZAogICMgUHJpbnQgdGhlIHJlYXNvbiBvZiB0aGUgZmFpbHVyZQogIGNhdCBnc3V0aWxfb3V0cHV0LnR4dAoKICAjIENoZWNrIGlmIGl0IG1hdGNoZXMgdGhlIEJ1Y2tldElzUmVxdWVzdGVyUGF5c0Vycm9yTWVzc2FnZQogIGlmIGdyZXAgLXEgIkJ1Y2tldCBpcyByZXF1ZXN0ZXIgcGF5cyBidWNrZXQgYnV0IG5vIHVzZXIgcHJvamVjdCBwcm92aWRlZC4iIGdzdXRpbF9vdXRwdXQudHh0OyB0aGVuCiAgICBwcmludGYgJyVzICVzXG4nICIkKGRhdGUgLXUgJyslWS8lbS8lZCAlSDolTTolUycpIiBSZXRyeWluZ1wgd2l0aFwgdXNlclwgcHJvamVjdAogICAgcm0gLWYgJEhPTUUvLmNvbmZpZy9nY2xvdWQvZ2NlICYmIGdzdXRpbCAtdSBicm9hZC1kc2RlLWNyb213ZWxsLWRldiAtaCAiQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluOyBjaGFyc2V0PVVURi04IiBjcCAvY3JvbXdlbGxfcm9vdC9zdGRlcnIgZ3M6Ly9jbG91ZC1jcm9td2VsbC1kZXYtc2VsZi1jbGVhbmluZy9jcm9td2VsbF9leGVjdXRpb24vY2kvdy9hZDU1MWVmZC1iYmY1LTQxMDgtOTIwMS1mNDAyMjFlZWE3OWYvY2FsbC1FL3NoYXJkLTQvCiAgZWxzZQogICAgZXhpdCAiJFJDX0dTVVRJTCIKICBmaQplbHNlCiAgZXhpdCAwCmZpCiAgKQogIFJDPSQ/CiAgaWYgWyAiJFJDIiA9ICIwIiBdOyB0aGVuCiAgICBicmVhawogIGZpCiAgaWYgWyAkaSAtbHQgMyBdOyB0aGVuCiAgICBwcmludGYgJyVzICVzXG4nICIkKGRhdGUgLXUgJyslWS8lbS8lZCAlSDolTTolUycpIiBXYWl0aW5nXCA1XCBzZWNvbmRzXCBhbmRcIHJldHJ5aW5nCiAgICBzbGVlcCA1CiAgZmkKZG9uZQpleGl0ICIkUkMiCiAgKSA+IC9kZXYvbnVsbCAyPiYxCiAgc2xlZXAgNjAKZG9uZQ==\\\"));' > /tmp/14385053-664d-4be4-a1ac-ca0eac7ff481.sh && chmod u+x /tmp/14385053-664d-4be4-a1ac-ca0eac7ff481.sh && sh /tmp/14385053-664d-4be4-a1ac-ca0eac7ff481.sh\"],\"mounts\":[{\"disk\":\"local-disk\",\"path\":\"/cromwell_root\"}],\"labels\":{\"tag\":\"Background\",\"outputName\":\"stderr\"},\"runInBackground\":true},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"python -c 'import base64; print(base64.b64decode(\\\"IyEvYmluL2Jhc2gKCndoaWxlIHRydWU7IGRvCiAgKAogICAgZm9yIGkgaW4gJChzZXEgMyk7IGRvCiAgKAogICAgcm0gLWYgJEhPTUUvLmNvbmZpZy9nY2xvdWQvZ2NlICYmIGdzdXRpbCAgLWggIkNvbnRlbnQtVHlwZTogdGV4dC9wbGFpbjsgY2hhcnNldD1VVEYtOCIgY3AgL2Nyb213ZWxsX3Jvb3Qvc3Rkb3V0IGdzOi8vY2xvdWQtY3JvbXdlbGwtZGV2LXNlbGYtY2xlYW5pbmcvY3JvbXdlbGxfZXhlY3V0aW9uL2NpL3cvYWQ1NTFlZmQtYmJmNS00MTA4LTkyMDEtZjQwMjIxZWVhNzlmL2NhbGwtRS9zaGFyZC00LyA+IGdzdXRpbF9vdXRwdXQudHh0IDI+JjEKIyBSZWNvcmQgdGhlIGV4aXQgY29kZSBvZiB0aGUgZ3N1dGlsIGNvbW1hbmQgd2l0aG91dCBwcm9qZWN0IGZsYWcKUkNfR1NVVElMPSQ/CmlmIFsgIiRSQ19HU1VUSUwiICE9ICIwIiBdOyB0aGVuCiAgcHJpbnRmICclcyAlc1xuJyAiJChkYXRlIC11ICcrJVkvJW0vJWQgJUg6JU06JVMnKSIgcm1cIC1mXCBcJEhPTUUvLmNvbmZpZy9nY2xvdWQvZ2NlXCBcJlwmXCBnc3V0aWxcIFwgLWhcIFwiQ29udGVudC1UeXBlOlwgdGV4dC9wbGFpblw7XCBjaGFyc2V0XD1VVEYtOFwiXCBjcFwgL2Nyb213ZWxsX3Jvb3Qvc3Rkb3V0XCBnczovL2Nsb3VkLWNyb213ZWxsLWRldi1zZWxmLWNsZWFuaW5nL2Nyb213ZWxsX2V4ZWN1dGlvbi9jaS93L2FkNTUxZWZkLWJiZjUtNDEwOC05MjAxLWY0MDIyMWVlYTc5Zi9jYWxsLUUvc2hhcmQtNC9cIGZhaWxlZAogICMgUHJpbnQgdGhlIHJlYXNvbiBvZiB0aGUgZmFpbHVyZQogIGNhdCBnc3V0aWxfb3V0cHV0LnR4dAoKICAjIENoZWNrIGlmIGl0IG1hdGNoZXMgdGhlIEJ1Y2tldElzUmVxdWVzdGVyUGF5c0Vycm9yTWVzc2FnZQogIGlmIGdyZXAgLXEgIkJ1Y2tldCBpcyByZXF1ZXN0ZXIgcGF5cyBidWNrZXQgYnV0IG5vIHVzZXIgcHJvamVjdCBwcm92aWRlZC4iIGdzdXRpbF9vdXRwdXQudHh0OyB0aGVuCiAgICBwcmludGYgJyVzICVzXG4nICIkKGRhdGUgLXUgJyslWS8lbS8lZCAlSDolTTolUycpIiBSZXRyeWluZ1wgd2l0aFwgdXNlclwgcHJvamVjdAogICAgcm0gLWYgJEhPTUUvLmNvbmZpZy9nY2xvdWQvZ2NlICYmIGdzdXRpbCAtdSBicm9hZC1kc2RlLWNyb213ZWxsLWRldiAtaCAiQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluOyBjaGFyc2V0PVVURi04IiBjcCAvY3JvbXdlbGxfcm9vdC9zdGRvdXQgZ3M6Ly9jbG91ZC1jcm9td2VsbC1kZXYtc2VsZi1jbGVhbmluZy9jcm9td2VsbF9leGVjdXRpb24vY2kvdy9hZDU1MWVmZC1iYmY1LTQxMDgtOTIwMS1mNDAyMjFlZWE3OWYvY2FsbC1FL3NoYXJkLTQvCiAgZWxzZQogICAgZXhpdCAiJFJDX0dTVVRJTCIKICBmaQplbHNlCiAgZXhpdCAwCmZpCiAgKQogIFJDPSQ/CiAgaWYgWyAiJFJDIiA9ICIwIiBdOyB0aGVuCiAgICBicmVhawogIGZpCiAgaWYgWyAkaSAtbHQgMyBdOyB0aGVuCiAgICBwcmludGYgJyVzICVzXG4nICIkKGRhdGUgLXUgJyslWS8lbS8lZCAlSDolTTolUycpIiBXYWl0aW5nXCA1XCBzZWNvbmRzXCBhbmRcIHJldHJ5aW5nCiAgICBzbGVlcCA1CiAgZmkKZG9uZQpleGl0ICIkUkMiCiAgKSA+IC9kZXYvbnVsbCAyPiYxCiAgc2xlZXAgNjAKZG9uZQ==\\\"));' > /tmp/fc70918b-10c9-4fc1-916f-011239d9f86b.sh && chmod u+x /tmp/fc70918b-10c9-4fc1-916f-011239d9f86b.sh && sh /tmp/fc70918b-10c9-4fc1-916f-011239d9f86b.sh\"],\"mounts\":[{\"disk\":\"local-disk\",\"path\":\"/cromwell_root\"}],\"labels\":{\"tag\":\"Background\",\"outputName\":\"stdout\"},\"runInBackground\":true},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"printf '%s %s\\\\n' \\\"$(date -u '+%Y/%m/%d %H:%M:%S')\\\" Starting\\\\ container\\\\ setup.\"],\"labels\":{\"logging\":\"ContainerSetup\"},\"timeout\":\"300s\"},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/bash\",\"-c\",\"mkdir -p /cromwell_root && chmod -R a+rwx /cromwell_root\"],\"mounts\":[{\"disk\":\"local-disk\",\"path\":\"/cromwell_root\"}],\"labels\":{\"tag\":\"ContainerSetup\"}},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"printf '%s %s\\\\n' \\\"$(date -u '+%Y/%m/%d %H:%M:%S')\\\" Done\\\\ container\\\\ setup.\"],\"labels\":{\"logging\":\"ContainerSetup\"},\"timeout\":\"300s\"},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"printf '%s %s\\\\n' \\\"$(date -u '+%Y/%m/%d %H:%M:%S')\\\" Starting\\\\ localization.\"],\"labels\":{\"logging\":\"Localization\"},\"timeout\":\"300s\"},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"python -c 'import base64; print(base64.b64decode(\\\"IyEvYmluL2Jhc2gKCmZvciBpIGluICQoc2VxIDMpOyBkbwogICgKICAgIHJtIC1mICRIT01FLy5jb25maWcvZ2Nsb3VkL2djZSAmJiBnc3V0aWwgIGNwIGdzOi8vY2xvdWQtY3JvbXdlbGwtZGV2LXNlbGYtY2xlYW5pbmcvY3JvbXdlbGxfZXhlY3V0aW9uL2NpL3cvYWQ1NTFlZmQtYmJmNS00MTA4LTkyMDEtZjQwMjIxZWVhNzlmL2NhbGwtRS9zaGFyZC00L2djc190cmFuc2Zlci5zaCAvY3JvbXdlbGxfcm9vdC9nY3NfdHJhbnNmZXIuc2ggPiBnc3V0aWxfb3V0cHV0LnR4dCAyPiYxCiMgUmVjb3JkIHRoZSBleGl0IGNvZGUgb2YgdGhlIGdzdXRpbCBjb21tYW5kIHdpdGhvdXQgcHJvamVjdCBmbGFnClJDX0dTVVRJTD0kPwppZiBbICIkUkNfR1NVVElMIiAhPSAiMCIgXTsgdGhlbgogIHByaW50ZiAnJXMgJXNcbicgIiQoZGF0ZSAtdSAnKyVZLyVtLyVkICVIOiVNOiVTJykiIHJtXCAtZlwgXCRIT01FLy5jb25maWcvZ2Nsb3VkL2djZVwgXCZcJlwgZ3N1dGlsXCBcIGNwXCBnczovL2Nsb3VkLWNyb213ZWxsLWRldi1zZWxmLWNsZWFuaW5nL2Nyb213ZWxsX2V4ZWN1dGlvbi9jaS93L2FkNTUxZWZkLWJiZjUtNDEwOC05MjAxLWY0MDIyMWVlYTc5Zi9jYWxsLUUvc2hhcmQtNC9nY3NfdHJhbnNmZXIuc2hcIC9jcm9td2VsbF9yb290L2djc190cmFuc2Zlci5zaFwgZmFpbGVkCiAgIyBQcmludCB0aGUgcmVhc29uIG9mIHRoZSBmYWlsdXJlCiAgY2F0IGdzdXRpbF9vdXRwdXQudHh0CgogICMgQ2hlY2sgaWYgaXQgbWF0Y2hlcyB0aGUgQnVja2V0SXNSZXF1ZXN0ZXJQYXlzRXJyb3JNZXNzYWdlCiAgaWYgZ3JlcCAtcSAiQnVja2V0IGlzIHJlcXVlc3RlciBwYXlzIGJ1Y2tldCBidXQgbm8gdXNlciBwcm9qZWN0IHByb3ZpZGVkLiIgZ3N1dGlsX291dHB1dC50eHQ7IHRoZW4KICAgIHByaW50ZiAnJXMgJXNcbicgIiQoZGF0ZSAtdSAnKyVZLyVtLyVkICVIOiVNOiVTJykiIFJldHJ5aW5nXCB3aXRoXCB1c2VyXCBwcm9qZWN0CiAgICBybSAtZiAkSE9NRS8uY29uZmlnL2djbG91ZC9nY2UgJiYgZ3N1dGlsIC11IGJyb2FkLWRzZGUtY3JvbXdlbGwtZGV2IGNwIGdzOi8vY2xvdWQtY3JvbXdlbGwtZGV2LXNlbGYtY2xlYW5pbmcvY3JvbXdlbGxfZXhlY3V0aW9uL2NpL3cvYWQ1NTFlZmQtYmJmNS00MTA4LTkyMDEtZjQwMjIxZWVhNzlmL2NhbGwtRS9zaGFyZC00L2djc190cmFuc2Zlci5zaCAvY3JvbXdlbGxfcm9vdC9nY3NfdHJhbnNmZXIuc2gKICBlbHNlCiAgICBleGl0ICIkUkNfR1NVVElMIgogIGZpCmVsc2UKICBleGl0IDAKZmkKICApCiAgUkM9JD8KICBpZiBbICIkUkMiID0gIjAiIF07IHRoZW4KICAgIGJyZWFrCiAgZmkKICBpZiBbICRpIC1sdCAzIF07IHRoZW4KICAgIHByaW50ZiAnJXMgJXNcbicgIiQoZGF0ZSAtdSAnKyVZLyVtLyVkICVIOiVNOiVTJykiIFdhaXRpbmdcIDVcIHNlY29uZHNcIGFuZFwgcmV0cnlpbmcKICAgIHNsZWVwIDUKICBmaQpkb25lCmV4aXQgIiRSQyI=\\\"));' > /tmp/0c8b26fb-5711-40aa-a177-ada1819f3cfa.sh && chmod u+x /tmp/0c8b26fb-5711-40aa-a177-ada1819f3cfa.sh && sh /tmp/0c8b26fb-5711-40aa-a177-ada1819f3cfa.sh\"],\"mounts\":[{\"disk\":\"local-disk\",\"path\":\"/cromwell_root\"}],\"labels\":{\"tag\":\"Localization\"}},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"python -c 'import base64; print(base64.b64decode(\\\"IyEvYmluL2Jhc2gKCmZvciBpIGluICQoc2VxIDMpOyBkbwogICgKICAgIHJtIC1mICRIT01FLy5jb25maWcvZ2Nsb3VkL2djZSAmJiBnc3V0aWwgIGNwIGdzOi8vY2xvdWQtY3JvbXdlbGwtZGV2LXNlbGYtY2xlYW5pbmcvY3JvbXdlbGxfZXhlY3V0aW9uL2NpL3cvYWQ1NTFlZmQtYmJmNS00MTA4LTkyMDEtZjQwMjIxZWVhNzlmL2NhbGwtRS9zaGFyZC00L2djc19sb2NhbGl6YXRpb24uc2ggL2Nyb213ZWxsX3Jvb3QvZ2NzX2xvY2FsaXphdGlvbi5zaCA+IGdzdXRpbF9vdXRwdXQudHh0IDI+JjEKIyBSZWNvcmQgdGhlIGV4aXQgY29kZSBvZiB0aGUgZ3N1dGlsIGNvbW1hbmQgd2l0aG91dCBwcm9qZWN0IGZsYWcKUkNfR1NVVElMPSQ/CmlmIFsgIiRSQ19HU1VUSUwiICE9ICIwIiBdOyB0aGVuCiAgcHJpbnRmICclcyAlc1xuJyAiJChkYXRlIC11ICcrJVkvJW0vJWQgJUg6JU06JVMnKSIgcm1cIC1mXCBcJEhPTUUvLmNvbmZpZy9nY2xvdWQvZ2NlXCBcJlwmXCBnc3V0aWxcIFwgY3BcIGdzOi8vY2xvdWQtY3JvbXdlbGwtZGV2LXNlbGYtY2xlYW5pbmcvY3JvbXdlbGxfZXhlY3V0aW9uL2NpL3cvYWQ1NTFlZmQtYmJmNS00MTA4LTkyMDEtZjQwMjIxZWVhNzlmL2NhbGwtRS9zaGFyZC00L2djc19sb2NhbGl6YXRpb24uc2hcIC9jcm9td2VsbF9yb290L2djc19sb2NhbGl6YXRpb24uc2hcIGZhaWxlZAogICMgUHJpbnQgdGhlIHJlYXNvbiBvZiB0aGUgZmFpbHVyZQogIGNhdCBnc3V0aWxfb3V0cHV0LnR4dAoKICAjIENoZWNrIGlmIGl0IG1hdGNoZXMgdGhlIEJ1Y2tldElzUmVxdWVzdGVyUGF5c0Vycm9yTWVzc2FnZQogIGlmIGdyZXAgLXEgIkJ1Y2tldCBpcyByZXF1ZXN0ZXIgcGF5cyBidWNrZXQgYnV0IG5vIHVzZXIgcHJvamVjdCBwcm92aWRlZC4iIGdzdXRpbF9vdXRwdXQudHh0OyB0aGVuCiAgICBwcmludGYgJyVzICVzXG4nICIkKGRhdGUgLXUgJyslWS8lbS8lZCAlSDolTTolUycpIiBSZXRyeWluZ1wgd2l0aFwgdXNlclwgcHJvamVjdAogICAgcm0gLWYgJEhPTUUvLmNvbmZpZy9nY2xvdWQvZ2NlICYmIGdzdXRpbCAtdSBicm9hZC1kc2RlLWNyb213ZWxsLWRldiBjcCBnczovL2Nsb3VkLWNyb213ZWxsLWRldi1zZWxmLWNsZWFuaW5nL2Nyb213ZWxsX2V4ZWN1dGlvbi9jaS93L2FkNTUxZWZkLWJiZjUtNDEwOC05MjAxLWY0MDIyMWVlYTc5Zi9jYWxsLUUvc2hhcmQtNC9nY3NfbG9jYWxpemF0aW9uLnNoIC9jcm9td2VsbF9yb290L2djc19sb2NhbGl6YXRpb24uc2gKICBlbHNlCiAgICBleGl0ICIkUkNfR1NVVElMIgogIGZpCmVsc2UKICBleGl0IDAKZmkKICApCiAgUkM9JD8KICBpZiBbICIkUkMiID0gIjAiIF07IHRoZW4KICAgIGJyZWFrCiAgZmkKICBpZiBbICRpIC1sdCAzIF07IHRoZW4KICAgIHByaW50ZiAnJXMgJXNcbicgIiQoZGF0ZSAtdSAnKyVZLyVtLyVkICVIOiVNOiVTJykiIFdhaXRpbmdcIDVcIHNlY29uZHNcIGFuZFwgcmV0cnlpbmcKICAgIHNsZWVwIDUKICBmaQpkb25lCmV4aXQgIiRSQyI=\\\"));' > /tmp/0ec9cdc5-f0f0-4ccf-ba66-1f3df900527a.sh && chmod u+x /tmp/0ec9cdc5-f0f0-4ccf-ba66-1f3df900527a.sh && sh /tmp/0ec9cdc5-f0f0-4ccf-ba66-1f3df900527a.sh\"],\"mounts\":[{\"disk\":\"local-disk\",\"path\":\"/cromwell_root\"}],\"labels\":{\"tag\":\"Localization\"}},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"/bin/bash /cromwell_root/gcs_localization.sh\"],\"mounts\":[{\"disk\":\"local-disk\",\"path\":\"/cromwell_root\"}],\"labels\":{\"tag\":\"Localization\"}},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"python -c 'import base64; print(base64.b64decode(\\\"IyEvYmluL2Jhc2gKCmZvciBpIGluICQoc2VxIDMpOyBkbwogICgKICAgIHJtIC1mICRIT01FLy5jb25maWcvZ2Nsb3VkL2djZSAmJiBnc3V0aWwgIGNwIGdzOi8vY2xvdWQtY3JvbXdlbGwtZGV2LXNlbGYtY2xlYW5pbmcvY3JvbXdlbGxfZXhlY3V0aW9uL2NpL3cvYWQ1NTFlZmQtYmJmNS00MTA4LTkyMDEtZjQwMjIxZWVhNzlmL2NhbGwtRS9zaGFyZC00L2djc19kZWxvY2FsaXphdGlvbi5zaCAvY3JvbXdlbGxfcm9vdC9nY3NfZGVsb2NhbGl6YXRpb24uc2ggPiBnc3V0aWxfb3V0cHV0LnR4dCAyPiYxCiMgUmVjb3JkIHRoZSBleGl0IGNvZGUgb2YgdGhlIGdzdXRpbCBjb21tYW5kIHdpdGhvdXQgcHJvamVjdCBmbGFnClJDX0dTVVRJTD0kPwppZiBbICIkUkNfR1NVVElMIiAhPSAiMCIgXTsgdGhlbgogIHByaW50ZiAnJXMgJXNcbicgIiQoZGF0ZSAtdSAnKyVZLyVtLyVkICVIOiVNOiVTJykiIHJtXCAtZlwgXCRIT01FLy5jb25maWcvZ2Nsb3VkL2djZVwgXCZcJlwgZ3N1dGlsXCBcIGNwXCBnczovL2Nsb3VkLWNyb213ZWxsLWRldi1zZWxmLWNsZWFuaW5nL2Nyb213ZWxsX2V4ZWN1dGlvbi9jaS93L2FkNTUxZWZkLWJiZjUtNDEwOC05MjAxLWY0MDIyMWVlYTc5Zi9jYWxsLUUvc2hhcmQtNC9nY3NfZGVsb2NhbGl6YXRpb24uc2hcIC9jcm9td2VsbF9yb290L2djc19kZWxvY2FsaXphdGlvbi5zaFwgZmFpbGVkCiAgIyBQcmludCB0aGUgcmVhc29uIG9mIHRoZSBmYWlsdXJlCiAgY2F0IGdzdXRpbF9vdXRwdXQudHh0CgogICMgQ2hlY2sgaWYgaXQgbWF0Y2hlcyB0aGUgQnVja2V0SXNSZXF1ZXN0ZXJQYXlzRXJyb3JNZXNzYWdlCiAgaWYgZ3JlcCAtcSAiQnVja2V0IGlzIHJlcXVlc3RlciBwYXlzIGJ1Y2tldCBidXQgbm8gdXNlciBwcm9qZWN0IHByb3ZpZGVkLiIgZ3N1dGlsX291dHB1dC50eHQ7IHRoZW4KICAgIHByaW50ZiAnJXMgJXNcbicgIiQoZGF0ZSAtdSAnKyVZLyVtLyVkICVIOiVNOiVTJykiIFJldHJ5aW5nXCB3aXRoXCB1c2VyXCBwcm9qZWN0CiAgICBybSAtZiAkSE9NRS8uY29uZmlnL2djbG91ZC9nY2UgJiYgZ3N1dGlsIC11IGJyb2FkLWRzZGUtY3JvbXdlbGwtZGV2IGNwIGdzOi8vY2xvdWQtY3JvbXdlbGwtZGV2LXNlbGYtY2xlYW5pbmcvY3JvbXdlbGxfZXhlY3V0aW9uL2NpL3cvYWQ1NTFlZmQtYmJmNS00MTA4LTkyMDEtZjQwMjIxZWVhNzlmL2NhbGwtRS9zaGFyZC00L2djc19kZWxvY2FsaXphdGlvbi5zaCAvY3JvbXdlbGxfcm9vdC9nY3NfZGVsb2NhbGl6YXRpb24uc2gKICBlbHNlCiAgICBleGl0ICIkUkNfR1NVVElMIgogIGZpCmVsc2UKICBleGl0IDAKZmkKICApCiAgUkM9JD8KICBpZiBbICIkUkMiID0gIjAiIF07IHRoZW4KICAgIGJyZWFrCiAgZmkKICBpZiBbICRpIC1sdCAzIF07IHRoZW4KICAgIHByaW50ZiAnJXMgJXNcbicgIiQoZGF0ZSAtdSAnKyVZLyVtLyVkICVIOiVNOiVTJykiIFdhaXRpbmdcIDVcIHNlY29uZHNcIGFuZFwgcmV0cnlpbmcKICAgIHNsZWVwIDUKICBmaQpkb25lCmV4aXQgIiRSQyI=\\\"));' > /tmp/2ae4c031-0825-45a6-b9eb-6cab53de4bcb.sh && chmod u+x /tmp/2ae4c031-0825-45a6-b9eb-6cab53de4bcb.sh && sh /tmp/2ae4c031-0825-45a6-b9eb-6cab53de4bcb.sh\"],\"mounts\":[{\"disk\":\"local-disk\",\"path\":\"/cromwell_root\"}],\"labels\":{\"tag\":\"Localization\"}},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"printf '%s %s\\\\n' \\\"$(date -u '+%Y/%m/%d %H:%M:%S')\\\" Done\\\\ localization.\"],\"labels\":{\"logging\":\"Localization\"},\"timeout\":\"300s\"},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"printf '%s %s\\\\n' \\\"$(date -u '+%Y/%m/%d %H:%M:%S')\\\" Running\\\\ user\\\\ action:\\\\ docker\\\\ run\\\\ -v\\\\ /mnt/local-disk:/cromwell_root\\\\ --entrypoint\\\\=\\\\ python@sha256:59b1b30ca434692bacd2beb3257cf7c4d5416532f04c1e4c475d2e76663d358b\\\\ /bin/bash\\\\ /cromwell_root/script\"],\"labels\":{\"logging\":\"UserAction\"},\"timeout\":\"300s\"},{\"imageUri\":\"python@sha256:59b1b30ca434692bacd2beb3257cf7c4d5416532f04c1e4c475d2e76663d358b\",\"commands\":[\"/bin/bash\",\"/cromwell_root/script\"],\"mounts\":[{\"disk\":\"local-disk\",\"path\":\"/cromwell_root\"}],\"labels\":{\"tag\":\"UserAction\"},\"credentials\":{\"keyName\":\"projects/broad-dsde-cromwell-dev/locations/global/keyRings/tj-test-private-dockerhub/cryptoKeys/tj-test-papi2\",\"cipherText\":\"CiQAn0fTLeGx6R0bKahbGkflHDIZcxTgFDpD0xY5IrSeWhFBG24SWgCsCYByhO4E1W1F4xsecdBB05s4XLgqE0gkvAPybEWaemPvYf9VqIDQ4isSUKm9TkjICQ7aBtChDh2s4lUemfU2sCpZwouPb/xBJdjEnZ8N/2wraLBTQgyQew==\"}},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"printf '%s %s\\\\n' \\\"$(date -u '+%Y/%m/%d %H:%M:%S')\\\" Starting\\\\ delocalization.\"],\"labels\":{\"logging\":\"Delocalization\"},\"timeout\":\"300s\"},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"/bin/bash /cromwell_root/gcs_delocalization.sh\"],\"mounts\":[{\"disk\":\"local-disk\",\"path\":\"/cromwell_root\"}],\"labels\":{\"tag\":\"Delocalization\"}},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"printf '%s %s\\\\n' \\\"$(date -u '+%Y/%m/%d %H:%M:%S')\\\" Done\\\\ delocalization.\"],\"labels\":{\"logging\":\"Delocalization\"},\"timeout\":\"300s\"},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"python -c 'import base64; print(base64.b64decode(\\\"IyEvYmluL2Jhc2gKCmZvciBpIGluICQoc2VxIDMpOyBkbwogICgKICAgIHJtIC1mICRIT01FLy5jb25maWcvZ2Nsb3VkL2djZSAmJiBnc3V0aWwgIC1oICJDb250ZW50LVR5cGU6IHRleHQvcGxhaW47IGNoYXJzZXQ9VVRGLTgiIGNwIC9nb29nbGUvbG9ncy9vdXRwdXQgZ3M6Ly9jbG91ZC1jcm9td2VsbC1kZXYtc2VsZi1jbGVhbmluZy9jcm9td2VsbF9leGVjdXRpb24vY2kvdy9hZDU1MWVmZC1iYmY1LTQxMDgtOTIwMS1mNDAyMjFlZWE3OWYvY2FsbC1FL3NoYXJkLTQvRS00LmxvZyA+IGdzdXRpbF9vdXRwdXQudHh0IDI+JjEKIyBSZWNvcmQgdGhlIGV4aXQgY29kZSBvZiB0aGUgZ3N1dGlsIGNvbW1hbmQgd2l0aG91dCBwcm9qZWN0IGZsYWcKUkNfR1NVVElMPSQ/CmlmIFsgIiRSQ19HU1VUSUwiICE9ICIwIiBdOyB0aGVuCiAgcHJpbnRmICclcyAlc1xuJyAiJChkYXRlIC11ICcrJVkvJW0vJWQgJUg6JU06JVMnKSIgcm1cIC1mXCBcJEhPTUUvLmNvbmZpZy9nY2xvdWQvZ2NlXCBcJlwmXCBnc3V0aWxcIFwgLWhcIFwiQ29udGVudC1UeXBlOlwgdGV4dC9wbGFpblw7XCBjaGFyc2V0XD1VVEYtOFwiXCBjcFwgL2dvb2dsZS9sb2dzL291dHB1dFwgZ3M6Ly9jbG91ZC1jcm9td2VsbC1kZXYtc2VsZi1jbGVhbmluZy9jcm9td2VsbF9leGVjdXRpb24vY2kvdy9hZDU1MWVmZC1iYmY1LTQxMDgtOTIwMS1mNDAyMjFlZWE3OWYvY2FsbC1FL3NoYXJkLTQvRS00LmxvZ1wgZmFpbGVkCiAgIyBQcmludCB0aGUgcmVhc29uIG9mIHRoZSBmYWlsdXJlCiAgY2F0IGdzdXRpbF9vdXRwdXQudHh0CgogICMgQ2hlY2sgaWYgaXQgbWF0Y2hlcyB0aGUgQnVja2V0SXNSZXF1ZXN0ZXJQYXlzRXJyb3JNZXNzYWdlCiAgaWYgZ3JlcCAtcSAiQnVja2V0IGlzIHJlcXVlc3RlciBwYXlzIGJ1Y2tldCBidXQgbm8gdXNlciBwcm9qZWN0IHByb3ZpZGVkLiIgZ3N1dGlsX291dHB1dC50eHQ7IHRoZW4KICAgIHByaW50ZiAnJXMgJXNcbicgIiQoZGF0ZSAtdSAnKyVZLyVtLyVkICVIOiVNOiVTJykiIFJldHJ5aW5nXCB3aXRoXCB1c2VyXCBwcm9qZWN0CiAgICBybSAtZiAkSE9NRS8uY29uZmlnL2djbG91ZC9nY2UgJiYgZ3N1dGlsIC11IGJyb2FkLWRzZGUtY3JvbXdlbGwtZGV2IC1oICJDb250ZW50LVR5cGU6IHRleHQvcGxhaW47IGNoYXJzZXQ9VVRGLTgiIGNwIC9nb29nbGUvbG9ncy9vdXRwdXQgZ3M6Ly9jbG91ZC1jcm9td2VsbC1kZXYtc2VsZi1jbGVhbmluZy9jcm9td2VsbF9leGVjdXRpb24vY2kvdy9hZDU1MWVmZC1iYmY1LTQxMDgtOTIwMS1mNDAyMjFlZWE3OWYvY2FsbC1FL3NoYXJkLTQvRS00LmxvZwogIGVsc2UKICAgIGV4aXQgIiRSQ19HU1VUSUwiCiAgZmkKZWxzZQogIGV4aXQgMApmaQogICkKICBSQz0kPwogIGlmIFsgIiRSQyIgPSAiMCIgXTsgdGhlbgogICAgYnJlYWsKICBmaQogIGlmIFsgJGkgLWx0IDMgXTsgdGhlbgogICAgcHJpbnRmICclcyAlc1xuJyAiJChkYXRlIC11ICcrJVkvJW0vJWQgJUg6JU06JVMnKSIgV2FpdGluZ1wgNVwgc2Vjb25kc1wgYW5kXCByZXRyeWluZwogICAgc2xlZXAgNQogIGZpCmRvbmUKZXhpdCAiJFJDIg==\\\"));' > /tmp/b7f8ac48-7d0d-4dc7-9708-b0af4914beb9.sh && chmod u+x /tmp/b7f8ac48-7d0d-4dc7-9708-b0af4914beb9.sh && sh /tmp/b7f8ac48-7d0d-4dc7-9708-b0af4914beb9.sh\"],\"labels\":{\"tag\":\"Delocalization\"},\"alwaysRun\":true},{\"imageUri\":\"gcr.io/google.com/cloudsdktool/cloud-sdk:276.0.0-slim\",\"commands\":[\"/bin/sh\",\"-c\",\"python -c 'import base64; print(base64.b64decode(\\\"IyEvYmluL2Jhc2gKCmZvciBpIGluICQoc2VxIDMpOyBkbwogICgKICAgIHJtIC1mICRIT01FLy5jb25maWcvZ2Nsb3VkL2djZSAmJiBnc3V0aWwgIC1oICJDb250ZW50LVR5cGU6IHRleHQvcGxhaW47IGNoYXJzZXQ9VVRGLTgiIC1tIHJzeW5jIC1yIC9nb29nbGUvbG9ncyBnczovL2Nsb3VkLWNyb213ZWxsLWRldi1zZWxmLWNsZWFuaW5nL2Nyb213ZWxsX2V4ZWN1dGlvbi9jaS93L2FkNTUxZWZkLWJiZjUtNDEwOC05MjAxLWY0MDIyMWVlYTc5Zi9jYWxsLUUvc2hhcmQtNC9waXBlbGluZXMtbG9ncyA+IGdzdXRpbF9vdXRwdXQudHh0IDI+JjEKIyBSZWNvcmQgdGhlIGV4aXQgY29kZSBvZiB0aGUgZ3N1dGlsIGNvbW1hbmQgd2l0aG91dCBwcm9qZWN0IGZsYWcKUkNfR1NVVElMPSQ/CmlmIFsgIiRSQ19HU1VUSUwiICE9ICIwIiBdOyB0aGVuCiAgcHJpbnRmICclcyAlc1xuJyAiJChkYXRlIC11ICcrJVkvJW0vJWQgJUg6JU06JVMnKSIgcm1cIC1mXCBcJEhPTUUvLmNvbmZpZy9nY2xvdWQvZ2NlXCBcJlwmXCBnc3V0aWxcIFwgLWhcIFwiQ29udGVudC1UeXBlOlwgdGV4dC9wbGFpblw7XCBjaGFyc2V0XD1VVEYtOFwiXCAtbVwgcnN5bmNcIC1yXCAvZ29vZ2xlL2xvZ3NcIGdzOi8vY2xvdWQtY3JvbXdlbGwtZGV2LXNlbGYtY2xlYW5pbmcvY3JvbXdlbGxfZXhlY3V0aW9uL2NpL3cvYWQ1NTFlZmQtYmJmNS00MTA4LTkyMDEtZjQwMjIxZWVhNzlmL2NhbGwtRS9zaGFyZC00L3BpcGVsaW5lcy1sb2dzXCBmYWlsZWQKICAjIFByaW50IHRoZSByZWFzb24gb2YgdGhlIGZhaWx1cmUKICBjYXQgZ3N1dGlsX291dHB1dC50eHQKCiAgIyBDaGVjayBpZiBpdCBtYXRjaGVzIHRoZSBCdWNrZXRJc1JlcXVlc3RlclBheXNFcnJvck1lc3NhZ2UKICBpZiBncmVwIC1xICJCdWNrZXQgaXMgcmVxdWVzdGVyIHBheXMgYnVja2V0IGJ1dCBubyB1c2VyIHByb2plY3QgcHJvdmlkZWQuIiBnc3V0aWxfb3V0cHV0LnR4dDsgdGhlbgogICAgcHJpbnRmICclcyAlc1xuJyAiJChkYXRlIC11ICcrJVkvJW0vJWQgJUg6JU06JVMnKSIgUmV0cnlpbmdcIHdpdGhcIHVzZXJcIHByb2plY3QKICAgIHJtIC1mICRIT01FLy5jb25maWcvZ2Nsb3VkL2djZSAmJiBnc3V0aWwgLXUgYnJvYWQtZHNkZS1jcm9td2VsbC1kZXYgLWggIkNvbnRlbnQtVHlwZTogdGV4dC9wbGFpbjsgY2hhcnNldD1VVEYtOCIgLW0gcnN5bmMgLXIgL2dvb2dsZS9sb2dzIGdzOi8vY2xvdWQtY3JvbXdlbGwtZGV2LXNlbGYtY2xlYW5pbmcvY3JvbXdlbGxfZXhlY3V0aW9uL2NpL3cvYWQ1NTFlZmQtYmJmNS00MTA4LTkyMDEtZjQwMjIxZWVhNzlmL2NhbGwtRS9zaGFyZC00L3BpcGVsaW5lcy1sb2dzCiAgZWxzZQogICAgZXhpdCAiJFJDX0dTVVRJTCIKICBmaQplbHNlCiAgZXhpdCAwCmZpCiAgKQogIFJDPSQ/CiAgaWYgWyAiJFJDIiA9ICIwIiBdOyB0aGVuCiAgICBicmVhawogIGZpCiAgaWYgWyAkaSAtbHQgMyBdOyB0aGVuCiAgICBwcmludGYgJyVzICVzXG4nICIkKGRhdGUgLXUgJyslWS8lbS8lZCAlSDolTTolUycpIiBXYWl0aW5nXCA1XCBzZWNvbmRzXCBhbmRcIHJldHJ5aW5nCiAgICBzbGVlcCA1CiAgZmkKZG9uZQpleGl0ICIkUkMi\\\"));' > /tmp/89db6e85-cd29-42de-93fe-dfa351eba579.sh && chmod u+x /tmp/89db6e85-cd29-42de-93fe-dfa351eba579.sh && sh /tmp/89db6e85-cd29-42de-93fe-dfa351eba579.sh\"],\"labels\":{\"tag\":\"Delocalization\"},\"alwaysRun\":true}],\"resources\":{\"zones\":[\"us-central1-b\"],\"virtualMachine\":{\"machineType\":\"custom-1-2048\",\"labels\":{\"wdl-task-name\":\"e\",\"goog-pipelines-worker\":\"true\",\"cromwell-workflow-id\":\"cromwell-ad551efd-bbf5-4108-9201-f40221eea79f\"},\"disks\":[{\"name\":\"local-disk\",\"sizeGb\":10,\"type\":\"pd-ssd\"}],\"network\":{},\"serviceAccount\":{\"email\":\"centaur@broad-dsde-cromwell-dev.iam.gserviceaccount.com\",\"scopes\":[\"https://www.googleapis.com/auth/compute\",\"https://www.googleapis.com/auth/devstorage.full_control\",\"https://www.googleapis.com/auth/cloudkms\",\"https://www.googleapis.com/auth/userinfo.email\",\"https://www.googleapis.com/auth/userinfo.profile\",\"https://www.googleapis.com/auth/monitoring.write\",\"https://www.googleapis.com/auth/bigquery\",\"https://www.googleapis.com/auth/cloud-platform\"]},\"bootDiskSizeGb\":11,\"bootImage\":\"projects/cos-cloud/global/images/family/cos-stable\"}},\"environment\":{\"MEM_UNIT\":\"GB\",\"MEM_SIZE\":\"2.0\"},\"timeout\":\"604800s\"}"
    val evt = jsonParser.parseAndClose[Event](new ByteArrayInputStream(jsonString.getBytes), StandardCharsets.UTF_8, classOf[Event])
    import cromwell.backend.google.pipelines.v2beta.PipelinesUtilityConversions._
    logger.error(Thread.currentThread.getName + "INVOKING getActionId")
    logger.error(Thread.currentThread.getName + "action id = " + evt.getActionId)
    logger.error(Thread.currentThread.getName + "INVOKED getActionId")
    evt
  }
}
